version: "1.0"

steps:

    clone-repo:
        type: git-clone
        title: "Clone ${{CF_REPO_NAME}} repo"
        repo: "${{CF_REPO_OWNER}}/${{CF_REPO_NAME}}"
        git: github
        revision: "${{CF_REVISION}}"

    preflight-pandas-check:
        description: "Get the current pandas version"
        type: "freestyle"
        image: alpine:3.13.1
        working_directory: ${{CF_VOLUME_PATH}}/${{CF_REPO_NAME}}
        commands:
            - cd build_scripts && ./pandas_check.sh
            
    ensure-python-git-pandas-exists:
        description: "Make sure the specified pandas version has a pre-built-image"
        type: freestyle
        image: "public.ecr.aws/q0i6b0q4/python-git-pandas:${{DEFAULT_NEUROAI_PYTHON_VERSION}}-${{DEFAULT_NEUROAI_GIT_VERSION}}-${{PANDAS_VERSION}}"
        commands:
            - echo "The required image exists"

    prepare_for_build:
        description: "Do any common preparation for tests"
        type: "freestyle"
        image: alpine:3.13.1
        working_directory: ${{CF_VOLUME_PATH}}/${{CF_REPO_NAME}}
        commands:
            # Set up some variables

            # It's our experience the the CF_VOLUME can leak between builds
            # Attempt to do some isolation.
            - export TEMP_DIR_OUTSIDE_CONTAINER=${{CF_VOLUME_PATH}}/tmp/${{CF_BUILD_ID}}
            - mkdir -p ${TEMP_DIR_OUTSIDE_CONTAINER}

            - export APP_HOME=/home/${{CF_REPO_OWNER}}
            - export APP_SOURCE=${APP_HOME}/${{CF_REPO_NAME}}

            # cf_export these variables so these vars can be used in later build steps
            - cf_export TEMP_DIR_OUTSIDE_CONTAINER APP_HOME APP_SOURCE

            # Temporarily atone for previous plugin sins that hint at CF_VOLUME leakage
            # between builds.
            # ??? This should be able to be deleted when our new-style codefresh is propagated
            - rm -rf leaf-common completion-service leaf-distributed leaf-server-common esp-sdk unileaf-util

    create-temp-git-creds-from-vault:
        title: "Get ephemeral GitHub creds"
        description: "Get temporary git credentials from vault server.
                      Create credential for use in docker secret with_creds_requirements"
        type: "freestyle"
        image: "vault:1.12.0"
        commands:
            # Login into Vault only once
            - >-
                vault login -address=${{VAULT}} -method=github token=${{VAULT_LOGIN}}
                | grep -Ev "(token |token_accessor)"

            # Get the ephemeral token for public repos
            - EPHEMERAL_TOKEN=$(vault read -address=${{VAULT}} -field=token /github-secrets/token/repo-read)
            - cf_export EPHEMERAL_LEAF_SOURCE_CREDENTIALS="x-access-token:${EPHEMERAL_TOKEN}"

            # Get the ephemeral token for private repos
            - EPHEMERAL_TOKEN=$(vault read -address=${{VAULT}} -field=token /github-private-secrets/token/repo-read)
            - cf_export EPHEMERAL_LEAF_PRIVATE_SOURCE_CREDENTIALS="x-access-token:${EPHEMERAL_TOKEN}"

            # Get other keys from vault needed below
            - export OPENAI_API_KEY=$(vault kv get -address=${{VAULT}} -field=key /secret/open-ai/api)
            - cf_export OPENAI_API_KEY --mask

    create-req-files-with-git-creds:
        title: "Create credentialed requirements files for secret build steps"
        type: "freestyle"
        image: python:${{DEFAULT_NEUROAI_PYTHON_VERSION}}-slim
        working_directory: ${{CF_VOLUME_PATH}}/${{CF_REPO_NAME}}
        commands:
            - python build_scripts/requirements_handler.py

    repo_build:
        title: "Building Docker image for ${{CF_REPO_NAME}}"
        type: "build"
        image_name: "leaf/${{CF_REPO_NAME}}"
        tag: ${{CF_BRANCH_TAG_NORMALIZED}}-${{CF_SHORT_REVISION}}
        working_directory: ${{CF_VOLUME_PATH}}/${{CF_REPO_NAME}}
        dockerfile: "build_scripts/Dockerfile"
        buildkit: true
        no_cf_cache: true
        disable_push: true
        # Docker BuildKit has different output. This progress plain allows
        # us to see the "old" style output which is useful.
        progress: "plain"
        # The src refers to our secret file on the host system. Within the
        # dockerfile we refer to the secret by id. By not providing a dst
        # the file ends up at the docker default of /run/secrets/<id>
        secrets:
            - id=with_creds_requirements,src=${{UNIT_TESTS_WITH_CREDS_REQUIREMENTS}}
        build_arguments:
            - REPO=${{CF_REPO_NAME}}
            - USERNAME=${{CF_REPO_OWNER}}
            - APP_HOME=${{APP_HOME}}
            - APP_SOURCE=${{APP_SOURCE}}
            - PYTHON_VERSION=${{DEFAULT_NEUROAI_PYTHON_VERSION}}
            - GIT_VERSION=${{DEFAULT_NEUROAI_GIT_VERSION}}
            - PANDAS_VERSION=${{PANDAS_VERSION}}

    run_all_tests:
        type: parallel
        fail_fast: false
        steps:
            run_pylint:
                title: Run pylint
                # Use the image created by the repo_build step above
                # See: https://codefresh.io/docs/docs/codefresh-yaml/variables/
                image: ${{repo_build}}
                description: "Run Pylint"
                # Specifically run in the APP_SOURCE directory inside the container,
                # *not* in the CF_VOLUME as we had erroneously done before.
                working_directory: ${{APP_SOURCE}}
                # Allow the pipeline to continue if this step fails
                fail_fast: false
                commands:
                    - pip3 freeze
                    - pylint --version
                    - build_scripts/run_pylint.sh

            run_flake8:
                title: Run flake8
                # Use the image created by the repo_build step above
                # See: https://codefresh.io/docs/docs/codefresh-yaml/variables/
                image: ${{repo_build}}
                description: "Run Flake8"
                # Specifically run in the APP_SOURCE directory inside the container,
                # *not* in the CF_VOLUME as we had erroneously done before.
                working_directory: ${{APP_SOURCE}}
                # Allow the pipeline to continue if this step fails
                fail_fast: false
                commands:
                    - pip3 freeze
                    - flake8 --version
                    # See repo ~/.flake8 file for settings
                    - flake8

            run_shellcheck:
                title: Run Static Analysis on Shell Scripts
                description: "Run shellcheck tool on our shell scripts"
                type: "freestyle"
                # Use the image created by the repo_build step above
                # See: https://codefresh.io/docs/docs/codefresh-yaml/variables/
                image: ${{repo_build}}
                # Specifically run in the APP_SOURCE directory inside the container,
                # *not* in the CF_VOLUME as we had erroneously done before.
                working_directory: ${{APP_SOURCE}}
                fail_fast: false
                commands:
                    - shellcheck --version
                    - ./build_scripts/run_shellcheck.sh

            run_fga_auth_tests:
                title: Run OpenFGA auth model tests
                description: "Run OpenFGA Authorization Model Tests"
                type: "freestyle"
                # Use the image created by the repo_build step above
                # See: https://codefresh.io/docs/docs/codefresh-yaml/variables/
                image: ${{repo_build}}
                # Specifically run in the APP_SOURCE directory inside the container,
                # *not* in the CF_VOLUME as we had erroneously done before.
                working_directory: ${{APP_SOURCE}}
                fail_fast: false
                commands:
                    - fga --version
                    - ./build_scripts/run_fga_tests.sh

            run_unit_tests:
                title: Run unit tests
                # Use the image created by the repo_build step above
                # See: https://codefresh.io/docs/docs/codefresh-yaml/variables/
                image: ${{repo_build}}
                description: Run unit tests (pytest)
                # Specifically run in the APP_SOURCE directory inside the container,
                # *not* in the CF_VOLUME as we had erroneously done before.
                working_directory: ${{APP_SOURCE}}
                fail_fast: false
                environment:
                    # UNILEAF SPECIAL
                    # This one does come from vault, above
                    - OPENAI_API_KEY=${{OPENAI_API_KEY}}
                    # The following values are used for mdserver unit tests
                    - DB_HOST=${{MDSERVER_TEST_DB_HOST}}
                    - DB_USERNAME=${{MDSERVER_TEST_DB_USERNAME}}
                    - DB_PASSWORD=${{MDSERVER_TEST_DB_PASSWORD}}
                    - DB_NAME=${{MDSERVER_TEST_DB_NAME}}
                    - DB_PORT=${{MDSERVER_TEST_DB_PORT}}
                    - AWS_BUCKET=${{MDSERVER_TEST_BUCKET}}
                    - AWS_ACCESS_KEY_ID=${{AWS_ACCESS_KEY_ID}}
                    - AWS_SECRET_ACCESS_KEY=${{AWS_SECRET_ACCESS_KEY}}
                commands:
                    - pip3 freeze
                    # These were used with nose, but currently pytest-timer
                    # does not allow configuration of colors like nose did.
                    # Still useful to document our desired thresholds:
                    #   --timer-ok 30s --timer-warning 60s
                    - pytest --version
                    - >
                      pytest
                      -n 4
                      --verbose
                      -m "not integration and not training"
                      --timer-top-n 10
                      --cov=backend
                      --cov=framework
                      --cov=serving
                      --cov=worker

            run_training_unit_tests:
                title: Run training unit tests
                # Use the image created by the repo_build step above
                # See: https://codefresh.io/docs/docs/codefresh-yaml/variables/
                image: ${{repo_build}}
                description: Run unit tests (pytest) that exercise training
                # Specifically run in the APP_SOURCE directory inside the container,
                # *not* in the CF_VOLUME as we had erroneously done before.
                working_directory: ${{APP_SOURCE}}
                fail_fast: false
                environment:
                    # UNILEAF SPECIAL
                    # XXX These could also come from vault
                    - ESP_SERVICE_USER=${{AUTH0_USERNAME}}
                    - ESP_SERVICE_PASSWORD=${{AUTH0_PASSWORD}}
                commands:
                    - pip3 freeze
                    # These were used with nose, but currently pytest-timer
                    # does not allow configuration of colors like nose did.
                    # Still useful to document our desired thresholds:
                    #   --timer-ok 30s --timer-warning 60s
                    - pytest --version
                    - >
                      pytest
                      -n 1
                      --verbose
                      -m "training"
                      --timer-top-n 10
                      --cov=backend
                      --cov=framework
                      --cov=serving
                      --cov=worker

    clean_up:
        description: "Clean up after ourselves"
        type: "freestyle"
        image: alpine:3.13.1
        working_directory: ${{CF_VOLUME_PATH}}/${{CF_REPO_NAME}}
        commands:
            # Clean up anything senstive we do not want to leak between builds
            - rm -rf ${{TEMP_DIR_OUTSIDE_CONTAINER}}

    all_test_status:
        title: Check For Failed Tests
        description: "Handle any fail cases that may have occurred"
        image: alpine:3.13.1
        commands:
            - exit 1
        when:
            condition:
                any:
                    static_test_fail:
                        steps.run_pylint.result == "failure" ||
                        steps.run_flake8.result == "failure" ||
                        steps.run_shellcheck.result == "failure" ||
                        steps.run_fga_auth_tests.result == "failure" ||
                        steps.run_unit_tests.result == "failure" ||
                        steps.run_training_unit_tests.result == "failure" ||
                        steps.run_all_tests.result == "failure"
