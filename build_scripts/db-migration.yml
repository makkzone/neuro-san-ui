# So you are about to undertake a db-migration.  Remember that this is quite a delicate operation
# and puts a certain release in a precarious state until the db-migration has been completed.
#
# Don't forget:
#   * Allow time for mistakes.  While a successful db-migration can take only 10 minutes,
#     a typical db-migration with problems takes ~3 hrs to resolve.
#     Mistakes in the db can be arduous to recover from.
#     *** Be sure all your attention is on the migration. ***
#   * There are 2 codefresh env vars in the build pipeline to be sure to set correctly:
#       * UNILEAF_VERSION - this is the tag and/or change hash for the release
#       * ENVIRONMENT_NAME - this is either dev, staging or prod.
#   * When doing a release to prod, be sure to use the same tag for prod as was used for staging
#   * The version of this db-migrations.yml should match the tag for the release.
#     CodeFresh actually does not easily take yaml from tags, so it might be necessary
#     to copy/paste the appropriate version of this file into the Inline YAML
version: "1.0"
steps:
    main_clone:
        # Using a clone step name of "main-clone" insures that the default
        # working_directory of all other steps is where this clone happened.
        title: "Cloning repository"
        type: "git-clone"
        repo: "leaf-ai/unileaf"
        git: "github"
        revision: ${{UNILEAF_VERSION}}

    create-temp-git-creds-from-vault:
        title: "Get ephemeral GitHub creds"
        description: "Get temporary git credentials from vault server.
                      Create credential for use in docker secret with_creds_requirements"
        type: "freestyle"
        image: "vault:1.12.0"
        commands:
            # Login into Vault only once
            - >-
                vault login -address=${{VAULT}} -method=github token=${{VAULT_LOGIN}}
                | grep -Ev "(token |token_accessor)"

            # Get the ephemeral token for public repos
            - EPHEMERAL_TOKEN=$(vault read -address=${{VAULT}} -field=token /github-secrets/token/repo-read)
            - cf_export EPHEMERAL_LEAF_SOURCE_CREDENTIALS="x-access-token:${EPHEMERAL_TOKEN}"

    create-req-files-with-git-creds:
        title: "Create credentialed requirements files for secret build steps"
        type: "freestyle"
        image: python:${{DEFAULT_NEUROAI_PYTHON_VERSION}}-slim
        working_directory: ${{CF_VOLUME_PATH}}/unileaf
        commands:
            # Set up a temporary place to store the credentialed reqs file
            - export TEMP_DIR_OUTSIDE_CONTAINER=${{CF_VOLUME_PATH}}/tmp/${{CF_BUILD_ID}}
            - mkdir -p ${TEMP_DIR_OUTSIDE_CONTAINER}
            # Now run the script to create the credentialed reqs file
            - python build_scripts/requirements_handler.py db_migration
            - pwd

    repo_build:
        title: "Building Docker image for db-migration"
        type: "build"
        image_name: "leaf/db-migration"
        tag: ${{UNILEAF_VERSION}}
        dockerfile: "backend/pmdserver/migrations/Dockerfile"
        buildkit: true
        # Docker BuildKit has different output. This progress plain allows
        # us to see the "old" style output which is useful.
        progress: "plain"
        # The src refers to our secret file on the host system. Within the
        # dockerfile we refer to the secret by id. By not providing a dst
        # the file ends up at the docker default of /run/secrets/<id>
        secrets:
            - id=with_creds_requirements,src=${{DB_MIGRATION_WITH_CREDS_REQUIREMENTS}}
        build_arguments:
            - REPO=unileaf
            - USERNAME=leaf-ai
            - APP_HOME=${{APP_HOME}}
            - APP_SOURCE=${{APP_SOURCE}}
            - PYTHON_VERSION=${{DEFAULT_NEUROAI_PYTHON_VERSION}}

    check_main_branch_yaml:
        description: "Checks if the main branch's version of this yaml is compatible with the tag"
        type: "freestyle"
        image: ${{repo_build}}
        shell: bash
        commands:
            - THIS_YAML_FILE=build_scripts/db-migration.yml
            # Check to see if there are any file differences in this file between main and the tag
            - DIFF_RESULT=$(git diff --name-only "${{UNILEAF_VERSION}}" main "${THIS_YAML_FILE}")
            # If this file is copy/pasted into Inline YAML for the build pipeline,
            # then this next line should be un-commented in the copy/pasted version.
            # - DIFF_RESULT=""
            - >-
              if [ "${DIFF_RESULT}" != "" ];
              then
              echo "${THIS_YAML_FILE} for tag ${{UNILEAF_VERSION}} differs from main.";
              echo "You probably need to copy this file from the ${{UNILEAF_VERSION}} tag into Inline YAML for the db-migration pipeline.";
              exit 1;
              fi
