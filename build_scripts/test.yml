# This pipeline runs the lint and unit tests on the ui code.

version: '1.0'
steps:
  clone:
    title: "Cloning repository"
    type: "git-clone"
    repo: "${{CF_REPO_OWNER}}/${{CF_REPO_NAME}}"
    revision: ${{CF_REVISION}}
    git: "github"

  create-temp-git-creds-from-vault:
    title: "Get ephemeral GitHub creds"
    description: "Get temporary git credentials from vault server
                  so we can checkout neuro-san repo for proto files"
    type: "freestyle"
    image: "vault:1.12.0"

    commands:
    # Login into Vault only once
      - >-
          vault login -address=${{VAULT}} -method=github token=${{VAULT_LOGIN}}
          | grep -Ev "(token |token_accessor)"

      # Get the ephemeral token for our source repos
      - EPHEMERAL_TOKEN=$(vault read -address=${{VAULT}} -field=token /github-secrets/token/repo-read)
      - cf_export LEAF_SOURCE_CREDENTIALS=${EPHEMERAL_TOKEN} --mask

  install_dependencies:
    title: Install npm/yarn dependencies
    description: Install npm/yarn dependencies as required
    image: node:${{NODEJS_VERSION}}-alpine
    working_directory: ${{CF_VOLUME_PATH}}/${{CF_REPO_NAME}}
    # We want this one to fail fast: no point continuing if we can't install dependencies
    fail_fast: true
    commands:
      - yarn --version
      - yarn install

  generate_typescript_api_stubs:
    title: Generate Typescript stubs for APIs
    image: node:${{NODEJS_VERSION}}-alpine
    working_directory: ${{CF_VOLUME_PATH}}/${{CF_REPO_NAME}}
    fail_fast: true
    commands:
      - apk add --quiet --no-progress --upgrade bash protobuf-dev git
      - ./build_scripts/do_typescript_generate.sh
      - ./build_scripts/do_openapi_generate.sh

  generate_openapi_types:
    title: Generate Typescript types for OpenAPI
    image: node:${{NODEJS_VERSION}}-alpine
    working_directory: ${{CF_VOLUME_PATH}}/neuro-ui
    commands:
      - npx tsx ./build_scripts/GenerateOpenAPITypes.ts

  run_eslint:
    title: Run eslint on Typescript sources
    image: node:${{NODEJS_VERSION}}-alpine
    working_directory: ${{CF_VOLUME_PATH}}/${{CF_REPO_NAME}}
    fail_fast: false
    commands:
      - apk add --quiet --no-progress --upgrade bash
      # Run test
      - ./build_scripts/run_eslint.sh

  run_prettier:
    title: Run prettier (code formatting checker)
    image: node:${{NODEJS_VERSION}}-alpine
    working_directory: ${{CF_VOLUME_PATH}}/${{CF_REPO_NAME}}
    fail_fast: false
    commands:
      - yarn check-format --version # Display version for troubleshooting
      - yarn check-format

  run_depcheck:
    title: Run depcheck (dependency checker)
    image: node:${{NODEJS_VERSION}}-alpine
    working_directory: ${{CF_VOLUME_PATH}}/${{CF_REPO_NAME}}
    fail_fast: false
    commands:
      - yarn depcheck --version  # Display version for troubleshooting
      - yarn depcheck

  run_ts_prune:
    title: Run ts-prune (looks for unused externals in modules)
    image: node:${{NODEJS_VERSION}}-alpine
    working_directory: ${{CF_VOLUME_PATH}}/${{CF_REPO_NAME}}
    fail_fast: false
    commands:
      # Display version for troubleshooting. Not perfect, but ts-prune doesn't support --version
      - yarn list --depth=0 --pattern ts-prune
      - yarn ts-prune --error

  run_unit_tests:
    title: Run unit tests
    image: node:${{NODEJS_VERSION}}-alpine
    description: Run unit tests (jest Typescript tests)
    working_directory: ${{CF_VOLUME_PATH}}/${{CF_REPO_NAME}}
    fail_fast: false
    commands:
      - yarn unit_test --version  # Display version for troubleshooting
      - yarn unit_test


  run_ts_compilation:
    title: Run Typescript compilation
    image: node:${{NODEJS_VERSION}}-alpine
    description: Run Typescript compiler to check for type issues
    working_directory: ${{CF_VOLUME_PATH}}/${{CF_REPO_NAME}}
    fail_fast: false
    commands:
      - yarn tsc --version  # Display version for troubleshooting
      - yarn tsc

  all_test_status:
    title: Check for failed steps
    description: "Force build to fail if any of the listed steps failed"
    image: alpine:3.13.1
    commands:
      - exit 1
    when:
      condition:
        any:
          static_test_fail:
            steps.run_eslint.result == 'failure' ||
            steps.run_prettier.result == 'failure' ||
            steps.run_unit_tests.result == 'failure' ||
            steps.run_depcheck.result == 'failure' ||
            steps.run_ts_compilation.result == 'failure' ||
            steps.run_ts_prune.result == 'failure' ||
            steps.generate_typescript_api_stubs.result == 'failure'
