# This pipeline runs selenium headless test(s) against the unileaf ui.

# The pipeline is configured with three shared credentials
# which are used by selenium to login to the unileaf ui as
# a github user. These values should not need to change in practice.

# The pipeline uses variables which the user may change as needed.
# 
# NODE_VERSION: The desired version of node. (Does not change often)
# VERSION: the version of unileaf containing the desired selenium test code.
#          Note, the version of unileaf actually under test is solely dependent
#          upon which environment is being tested (dev/staging/production).
#
# EXPECTED_CHROME_VERSION: Set this to the desired version matching our 
#                          selenium_runner image(s) in AWS ECR.
# SIDERUNNER_VERSION: The desired version of selenium side runner

# NOTE that the image tag used in this pipeline is constructed of
# the EXPECTED_CHROME_VERSION and SIDERUNNER_VERSION
# For example, an actual tag will look like this
# 122.0.6261.57-4.0.0-alpha.46
# This image must be built in a separate pipeline "build-selenium-headless".

# This script relies on a pre-built selenium runner docker image
# that we build in a separate pipeline (build-selenium-headless). This allows us to capture
# working chrome/chromedriver pairs. The only way I've found to make chrome
# and chromedriver work within selenium is to first install the latest
# chrome debian package, and then install the matching version of the
# chrome driver. However, these two items can sometimes get out of sync
# (a new debian package may be released, but before the matching chromedriver
# is available). So we do some preflight checks in this pipeline.
# We find the latest debian package, and compare that to what we are currently
# using. If there is a new debian package, the version test will fail and alert us
# to the update. At that time we can run the build-selenium-headless pipeline to 
# capture the new bits, and update the pipelines via pipeline variables to use this
# newer version. We can also override the version check, in case there is a new
# version that doesn't work for us, or if the latest driver is missing.
 
# For the actual test script
#     TEST_FILE: This is the list of tests to run.
#     SIDE_FILE: The selenium ide file (.side file) to use for the test.
#     GITHUB*: The login credentials

version: "1.0"

steps:
  clone_repo:
    type: git-clone
    title: "Clone unileaf repo"
    repo: "leaf-ai/unileaf"
    git: github
    revision: ${{VERSION}}
    
  run_selenium_headless:
    title: "Run selenium headless UI test"
    type: "freestyle"
    image: "${{IMAGE_LOCATION}}:${{DESIRED_TAG}}"
    working_directory: ${{CF_VOLUME_PATH}}/unileaf/tests/selenium/headless
    commands:
      - python3 selenium_test_runner.py ${{GITHUB_OTP_SECRET}} ${{SIDE_FILE}} ${{GITHUB_USERNAME}} ${{GITHUB_PASSWORD}} ${{TEST_FILE}}

