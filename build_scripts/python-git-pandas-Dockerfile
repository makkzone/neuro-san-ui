# Set python image as base image

# Here we purposely hard code the python version because
# this image must be built before we take a new python version
# for the entire neuro ai service stack. This image gets built and 
# pushed once and is consumed as the starting FROM for the service
# containers.
FROM python:3.12-slim

# Define the build argument for the Git version, no default provided by design
ARG GIT_VERSION
ARG PANDAS_VERSION

# Set the Git version as an environment variable
ENV GIT_VERSION=${GIT_VERSION}
ENV PANDAS_VERSION=${PANDAS_VERSION}

# Set the shell and options per hadolint recommendations
SHELL ["/bin/bash", "-o", "pipefail", "-c"]

# Set the temporary working directory for downloading and building Git
WORKDIR /tmp

# Install dependencies required to build Git from source
# hadolint ignore=DL3008
RUN apt-get update && apt-get install --yes \
    build-essential \
    dh-autoreconf \
    libcurl4-gnutls-dev \
    libexpat1-dev \
    gettext \
    libz-dev \
    libssl-dev \
    curl \
    --no-install-recommends && \
    curl -LO https://github.com/git/git/archive/refs/tags/v${GIT_VERSION}.tar.gz && \
    tar -zxf v${GIT_VERSION}.tar.gz && \ 
    rm -rf /var/lib/apt/lists/* && \ 
    pip install pandas==${PANDAS_VERSION} --prefix=/install --no-cache-dir

# Change to the Git source directory to build and install Git
WORKDIR /tmp/git-${GIT_VERSION}

RUN make prefix=/usr/local all && \
    make prefix=/usr/local install

# Reset to the root directory
WORKDIR /

