# This pipeline takes a chrome driver location along
# with other variables to build an image that
# we then use in CF automated tests using the 
# selenium runner.

version: "1.0"
steps:
  main_clone:
    title: "Cloning repository"
    type: "git-clone"
    repo: "leaf-ai/unileaf"
    revision: ${{UNILEAF_VERSION}}

  get_chrome_for_testing_version:
    type: "freestyle"
    title: "Determine stable chrome-for-testing version"
    image: apteno/alpine-jq:2024-02-04
    # CFT is short for chrome for testing. 
    # https://googlechromelabs.github.io/chrome-for-testing/
    commands:
      - LATEST_CHROME_JSON=$(curl -s https://googlechromelabs.github.io/chrome-for-testing/last-known-good-versions-with-downloads.json | jq '.channels.Stable')
      - cf_export CFT_CHROME_URL=$(echo "$LATEST_CHROME_JSON" | jq -r '.downloads.chrome[] | select(.platform == "linux64") | .url')
      - cf_export CFT_CHROMEDRIVER_URL=$(echo "$LATEST_CHROME_JSON" | jq -r '.downloads.chromedriver[] | select(.platform == "linux64") | .url')
      - cf_export CFT_VERSION=$(echo "$LATEST_CHROME_JSON" | jq -r '.version')

  get_google_chrome_stable_current_deb_package_version:
    type: "freestyle"
    title: "Determine latest debian package version"
    image: "ubuntu:20.04"
    commands:
      - export DEBIAN_FRONTEND=noninteractive
      - apt  update --yes
      - apt-get update
      - apt-get install libnss3-dev libgdk-pixbuf2.0-dev libgtk-3-dev libxss-dev wget unzip ca-certificates curl gnupg --yes
       # Install google chrome stable to see what version it is.
      - wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
      - apt install ./google-chrome-stable_current_amd64.deb --yes
      - /usr/bin/google-chrome --version
      - cf_export CHROME_STABLE_DEB_VERSION=$(/usr/bin/google-chrome --version | awk '{print $3}')


  validate_chrome_versions:
    type: "freestyle"
    title: "Validate the chrome version(s) are as expected"
    image: alpine:latest
    commands:
      - echo ${CHROME_STABLE_DEB_VERSION}
      - echo ${CFT_VERSION}
      - echo ${CFT_CHROMEDRIVER_URL}
      - echo ${CFT_CHROME_URL}
      # If the current stable debian package doesn't match the chrome version
      # we have specified, bail with error.
      - echo "Check latest stable versus our currently specified version"
      - echo "${CHROME_STABLE_DEB_VERSION} vs ${{DESIRED_CHROME_VERSION}}"
      - sh -c "[ \"$CHROME_STABLE_DEB_VERSION\" = \"${{DESIRED_CHROME_VERSION}}\" ] || exit 1"

      # Now make sure the CFT version matches our specified version.
      - echo "Check Chrome For Testing versus  our currently specified version"
      - echo "${CFT_VERSION} vs ${{DESIRED_CHROME_VERSION}}"
      - sh -c "[ \"$CFT_VERSION\" = \"${{DESIRED_CHROME_VERSION}}\" ] || exit 1"

    # If you want to build a container where the chome browser version
    # does not match the driver version, set this pipeline variable to false.
    when:
      condition:
        all:
          version_check: '"${{ENFORCE_VERSION_CHECK}}" == "true"'

  build:
    title: "Building Docker image"
    type: "build"
    image_name: "leaf/selenium-headless"
    # If the version validation is enabled, then CFT_VERSION will equal
    # the DESIRED_CHROME_VERSION. If validation is disabled, the two values
    # will not be equal, but in either case, we will be installing the 
    # DESIRED_CHOME_VERSION of the chrome driver. So that value is used
    # in the tag below.
    tag: "${{CHROME_STABLE_DEB_VERSION}}-${{DESIRED_CHROME_VERSION}}-${{SIDERUNNER_VERSION}}"
    dockerfile: "tests/selenium/headless/Dockerfile"
    build_arguments:
      - CHROME_VERSION=${{DESIRED_CHROME_VERSION}}
      - NODE_VERSION=${{NODE_VERSION}}
      - SIDERUNNER_VERSION=${{SIDERUNNER_VERSION}}
