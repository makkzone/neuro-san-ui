#    Copyright 2025 Cognizant Technology Solutions Corp, www.cognizant.com.
#    
#    Licensed under the Apache License, Version 2.0 (the "License");
#    you may not use this file except in compliance with the License.
#    You may obtain a copy of the License at
#
#    http://www.apache.org/licenses/LICENSE-2.0
#    
#    Unless required by applicable law or agreed to in writing, software
#    distributed under the License is distributed on an "AS IS" BASIS,
#    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#    See the License for the specific language governing permissions and
#    limitations under the License.

# ================================================================================
# Test Workflow
# ================================================================================
# Purpose: Run comprehensive code quality checks and unit tests
#
# Trigger Scenarios:
# - Called by orchestrator workflow (automatic flow)
# - Manual trigger: Allows testing any arbitrary version/branch
# ================================================================================

# Note: this is mostly copy-pasta from the same Action in neuro-ui :thumbsdown:
# See: https://leaf-ai.atlassian.net/browse/UN-3573

name: Test

on:
    # Allow manual workflow dispatch
    workflow_dispatch:
        inputs:
            revision:
                description: "Git ref (tag/branch/SHA) to checkout"
                required: false
                type: string
    # Allow being called by other workflows
    workflow_call:
        inputs:
            revision:
                required: false
                type: string

env:
    # AWS info needed to push the image to ECR
    AWS_REGION: ${{ vars.AWS_REGION || 'us-west-2' }}
    # and the nodejs version which is a repo-level variable
    NODEJS_VERSION: ${{ vars.NODEJS_VERSION }}

permissions:
    contents: read

jobs:
    test:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0
                  ref: ${{ inputs.revision || github.ref }}

            # Install yarn version from package.json packageManager field using corepack
            # "corepack install" reads package.json and installs the right yarn version from the packageManager field
            - name: Set up yarn version
              run: |
                  corepack enable
                  corepack install 
                  yarn --version

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  # Specific version. 22.18+ is bad due to https://github.com/nodejs/node/issues/59364 and breaks tests.
                  node-version: 22.17.1
                  cache: yarn

            - name: Install dependencies
              run: |
                  rm -rf node_modules
                  yarn cache clean --all
                  yarn install

            - name: Install prerequisites for code generation
              run: |
                  sudo apt-get update -y > /dev/null
                  sudo apt-get install -y --no-install-recommends --no-install-suggests \
                    bash shellcheck > /dev/null

            - name: Generate OpenAPI types
              run: yarn generate

            - name: Run ESLint
              id: eslint
              continue-on-error: true
              run: |
                  ./build_scripts/run_eslint.sh

            - name: Run ShellCheck
              id: shellcheck
              continue-on-error: true
              run: |
                  ./build_scripts/run_shellcheck.sh

            - name: Run Prettier (formatting check)
              id: prettier
              continue-on-error: true
              run: |
                  yarn check-format --version
                  yarn check-format

            - name: Run knip (unused dependencies/exports check)
              id: knip
              continue-on-error: true
              run: |
                  yarn knip --version
                  yarn knip

            - name: Lint Dockerfiles (hadolint)
              uses: hadolint/hadolint-action@2332a7b74a6de0dda2e2221d575162eba76ba5e5
              id: hadolint
              continue-on-error: true
              with:
                  dockerfile: apps/main/Dockerfile
                  recursive: true
                  failure-threshold: info

            - name: Docker build check
              id: dockerbuild
              continue-on-error: true
              run: |
                  docker build --quiet --check --file apps/main/Dockerfile . > /dev/null

            - name: Run TypeScript compilation
              id: tsc
              continue-on-error: true
              run: |
                  yarn tsc --version
                  yarn tsc

            - name: Run unit tests
              id: unit
              continue-on-error: true
              run: |
                  node --version
                  yarn test --version
                  yarn test

            - name: Roll up QA results and set final job status
              if: always()
              env:
                  STATUS_eslint: ${{ steps.eslint.outcome }}
                  STATUS_shellcheck: ${{ steps.shellcheck.outcome }}
                  STATUS_prettier: ${{ steps.prettier.outcome }}
                  STATUS_knip: ${{ steps.knip.outcome }}
                  STATUS_hadolint: ${{ steps.hadolint.outcome }}
                  STATUS_dockerbuild: ${{ steps.dockerbuild.outcome }}
                  STATUS_tsc: ${{ steps.tsc.outcome }}
                  STATUS_unit: ${{ steps.unit.outcome }}
              run: |
                  failures=()
                  summarize() {
                    step_id="$1"; step_name="$2"
                    status_var="STATUS_${step_id}"
                    status_value="${!status_var:-unknown}"
                    if [ "$status_value" = "failure" ] || [ "$status_value" = "cancelled" ]; then
                      failures+=("$step_name")
                    fi
                    echo "- ${step_name}: ${status_value}" >> "$GITHUB_STEP_SUMMARY"
                  }

                  echo "### Quality and Test Results" >> "$GITHUB_STEP_SUMMARY"
                  summarize eslint "ESLint"
                  summarize shellcheck "ShellCheck"
                  summarize prettier "Prettier"
                  summarize hadolint "hadolint"
                  summarize dockerbuild "dockerbuild"
                  summarize knip "knip"
                  summarize tsc "TypeScript Compile"
                  summarize unit "Unit Tests"

                  if [ ${#failures[@]} -gt 0 ]; then
                    echo "Failures detected: ${failures[*]}" >> "$GITHUB_STEP_SUMMARY"
                    exit 1
                  fi
