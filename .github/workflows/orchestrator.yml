#    Copyright 2025 Cognizant Technology Solutions Corp, www.cognizant.com.
#
#    Licensed under the Apache License, Version 2.0 (the "License");
#    you may not use this file except in compliance with the License.
#    You may obtain a copy of the License at
#
#    http://www.apache.org/licenses/LICENSE-2.0
#
#    Unless required by applicable law or agreed to in writing, software
#    distributed under the License is distributed on an "AS IS" BASIS,
#    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#    See the License for the specific language governing permissions and
#    limitations under the License.

# ================================================================================
# Orchestrator Workflow
# ================================================================================
# Purpose: Orchestrate the CI/CD flow based on trigger type
#
# Trigger Scenarios:
# - Push to any branch: Runs tests only (for development feedback)
# - Push to main branch: Runs test → build → deploy to dev
# - GitHub release: Runs test → build → deploy to staging
# ================================================================================

# Note: this is mostly copy-pasta from the same Action in neuro-ui :thumbsdown:
# See: https://leaf-ai.atlassian.net/browse/UN-3573

name: Orchestrator

on:
    # Trigger on pushes to any branch
    push:
        branches: ["**"]
    # Trigger on GitHub release events
    release:
        types: [published]

permissions:
    id-token: write
    contents: read

jobs:
    setup:
        runs-on: ubuntu-latest
        outputs:
            version: ${{ steps.version.outputs.version }}
            deploy_env: ${{ steps.version.outputs.deploy_env }}
            should_build: ${{ steps.version.outputs.should_build }}
            should_deploy: ${{ steps.version.outputs.should_deploy }}
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Determine version and deployment environment
              id: version
              shell: bash
              run: |
                  ./build_scripts/determine_version.sh \
                    "${{ github.event_name }}" \
                    "${{ github.ref }}" \
                    "${{ github.event.release.tag_name }}" \
                    "${{ github.sha }}"

    # Step 1: Always run tests
    test:
        uses: ./.github/workflows/test.yml
        needs: setup
        with:
            revision: ${{ github.ref }}

    # Step 2: Build Docker image (only for main/release)
    build:
        uses: ./.github/workflows/build.yml
        needs: [setup, test]
        if: needs.test.result == 'success' && needs.setup.outputs.should_build == 'true'
        with:
            revision: ${{ github.ref }}
            DISPLAY_VERSION: ${{ needs.setup.outputs.version }}

    # Step 3: Deploy to environment (only for main/release)
    # Triggers neuro-san-deploy to update the UI image tag in the target environment
    deploy:
        runs-on: ubuntu-latest
        needs: [setup, build]
        if: needs.build.result == 'success' && needs.setup.outputs.should_deploy == 'true'
        steps:
            - name: Trigger deployment to neuro-san-deploy
              uses: peter-evans/repository-dispatch@v3
              with:
                  token: ${{ secrets.NEURO_SAN_DEPLOY_DISPATCH_TOKEN }}
                  repository: cognizant-ai-lab/neuro-san-deploy
                  event-type: ui_deploy
                  client-payload: |
                      {
                        "source_repo": "${{ github.repository }}",
                        "ref": "${{ github.ref_name }}",
                        "sha": "${{ github.sha }}",
                        "target_environment": "${{ needs.setup.outputs.deploy_env }}",
                        "image_tag": "${{ needs.build.outputs.image_tag }}",
                        "sender": "${{ github.actor }}"
                      }
