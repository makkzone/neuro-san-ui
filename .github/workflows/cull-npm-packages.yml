#    Copyright 2025 Cognizant Technology Solutions Corp, www.cognizant.com.
#
#    Licensed under the Apache License, Version 2.0 (the "License");
#    you may not use this file except in compliance with the License.
#    You may obtain a copy of the License at
#
#    http://www.apache.org/licenses/LICENSE-2.0
#
#    Unless required by applicable law or agreed to in writing, software
#    distributed under the License is distributed on an "AS IS" BASIS,
#    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#    See the License for the specific language governing permissions and
#    limitations under the License.

# ================================================================================
# Cull NPM Packages Workflow
# ================================================================================
# Purpose: Clean up old non-release npm packages to prevent package proliferation.
#
# Schedule: Runs weekly on Sunday at 00:00 UTC
#
# Retention Policy:
# - Release packages (version format: x.y.z) are NEVER deleted
# - Non-release packages (version format: x.y.z-main.sha.run or x.y.z-pr.sha.run)
#   older than 14 days are deleted
#
# The workflow uses the GitHub API to list and delete package versions.
# ================================================================================

name: Cull NPM Packages

on:
    schedule:
        # Run weekly on Sunday at 00:00 UTC
        - cron: "0 0 * * 0"
    workflow_dispatch:
        inputs:
            dry_run:
                description: "Dry run (don't actually delete packages)"
                type: boolean
                default: true
            retention_days:
                description: "Delete non-release packages older than N days"
                type: number
                default: 14

env:
    PACKAGE_NAME: ui-common
    PACKAGE_OWNER: cognizant-ai-lab
    # Default retention period in days (can be overridden by workflow_dispatch input)
    DEFAULT_RETENTION_DAYS: 14

permissions:
    packages: write

jobs:
    cull-packages:
        runs-on: ubuntu-latest
        steps:
            - name: Determine parameters
              id: params
              run: |
                  if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
                    DRY_RUN="${{ inputs.dry_run }}"
                    RETENTION_DAYS="${{ inputs.retention_days }}"
                  else
                    # Scheduled runs are NOT dry runs
                    DRY_RUN="false"
                    RETENTION_DAYS="${{ env.DEFAULT_RETENTION_DAYS }}"
                  fi
                  echo "dry_run=$DRY_RUN" >> $GITHUB_OUTPUT
                  echo "retention_days=$RETENTION_DAYS" >> $GITHUB_OUTPUT
                  echo "Dry run: $DRY_RUN"
                  echo "Retention days: $RETENTION_DAYS"

            - name: Calculate cutoff date
              id: cutoff
              run: |
                  RETENTION_DAYS="${{ steps.params.outputs.retention_days }}"
                  CUTOFF_DATE=$(date -d "$RETENTION_DAYS days ago" -u +%Y-%m-%dT%H:%M:%SZ)
                  echo "cutoff_date=$CUTOFF_DATE" >> $GITHUB_OUTPUT
                  echo "Cutoff date: $CUTOFF_DATE"
                  echo "Packages created before this date will be considered for deletion"

            - name: List and cull packages
              id: cull
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  PACKAGE_NAME="${{ env.PACKAGE_NAME }}"
                  PACKAGE_OWNER="${{ env.PACKAGE_OWNER }}"
                  CUTOFF_DATE="${{ steps.cutoff.outputs.cutoff_date }}"
                  DRY_RUN="${{ steps.params.outputs.dry_run }}"
                  
                  echo "Fetching package versions for @${PACKAGE_OWNER}/${PACKAGE_NAME}..."
                  
                  # Initialize counters
                  TOTAL_VERSIONS=0
                  RELEASE_VERSIONS=0
                  KEPT_VERSIONS=0
                  DELETED_VERSIONS=0
                  WOULD_DELETE_VERSIONS=0
                  
                  # Fetch all package versions (paginated)
                  PAGE=1
                  PER_PAGE=100
                  
                  while true; do
                    RESPONSE=$(gh api \
                      -H "Accept: application/vnd.github+json" \
                      -H "X-GitHub-Api-Version: 2022-11-28" \
                      "/orgs/${PACKAGE_OWNER}/packages/npm/${PACKAGE_NAME}/versions?per_page=${PER_PAGE}&page=${PAGE}" \
                      2>/dev/null || echo "[]")
                    
                    if [ "$RESPONSE" = "[]" ] || [ -z "$RESPONSE" ]; then
                      break
                    fi
                    
                    # Process each version
                    echo "$RESPONSE" | jq -c '.[]' | while read -r VERSION_JSON; do
                      VERSION_ID=$(echo "$VERSION_JSON" | jq -r '.id')
                      VERSION_NAME=$(echo "$VERSION_JSON" | jq -r '.name')
                      CREATED_AT=$(echo "$VERSION_JSON" | jq -r '.created_at')
                      
                      TOTAL_VERSIONS=$((TOTAL_VERSIONS + 1))
                      
                      # Check if this is a release version (format: x.y.z without any suffix)
                      # Release versions match: ^[0-9]+\.[0-9]+\.[0-9]+$
                      if echo "$VERSION_NAME" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+$'; then
                        echo "KEEP (release): $VERSION_NAME (created: $CREATED_AT)"
                        RELEASE_VERSIONS=$((RELEASE_VERSIONS + 1))
                        continue
                      fi
                      
                      # Check if the package is older than the cutoff date
                      if [[ "$CREATED_AT" < "$CUTOFF_DATE" ]]; then
                        if [ "$DRY_RUN" = "true" ]; then
                          echo "WOULD DELETE: $VERSION_NAME (created: $CREATED_AT)"
                          WOULD_DELETE_VERSIONS=$((WOULD_DELETE_VERSIONS + 1))
                        else
                          echo "DELETING: $VERSION_NAME (created: $CREATED_AT)"
                          gh api \
                            --method DELETE \
                            -H "Accept: application/vnd.github+json" \
                            -H "X-GitHub-Api-Version: 2022-11-28" \
                            "/orgs/${PACKAGE_OWNER}/packages/npm/${PACKAGE_NAME}/versions/${VERSION_ID}" \
                            2>/dev/null || echo "Failed to delete version $VERSION_NAME"
                          DELETED_VERSIONS=$((DELETED_VERSIONS + 1))
                        fi
                      else
                        echo "KEEP (recent): $VERSION_NAME (created: $CREATED_AT)"
                        KEPT_VERSIONS=$((KEPT_VERSIONS + 1))
                      fi
                    done
                    
                    # Check if there are more pages
                    VERSION_COUNT=$(echo "$RESPONSE" | jq 'length')
                    if [ "$VERSION_COUNT" -lt "$PER_PAGE" ]; then
                      break
                    fi
                    PAGE=$((PAGE + 1))
                  done
                  
                  # Output summary
                  echo ""
                  echo "=== Summary ==="
                  echo "Total versions processed: $TOTAL_VERSIONS"
                  echo "Release versions (kept): $RELEASE_VERSIONS"
                  echo "Recent versions (kept): $KEPT_VERSIONS"
                  if [ "$DRY_RUN" = "true" ]; then
                    echo "Versions that would be deleted: $WOULD_DELETE_VERSIONS"
                  else
                    echo "Versions deleted: $DELETED_VERSIONS"
                  fi
                  
                  # Set outputs for summary
                  echo "total=$TOTAL_VERSIONS" >> $GITHUB_OUTPUT
                  echo "release=$RELEASE_VERSIONS" >> $GITHUB_OUTPUT
                  echo "kept=$KEPT_VERSIONS" >> $GITHUB_OUTPUT
                  echo "deleted=$DELETED_VERSIONS" >> $GITHUB_OUTPUT
                  echo "would_delete=$WOULD_DELETE_VERSIONS" >> $GITHUB_OUTPUT

            - name: Summary
              if: always()
              run: |
                  DRY_RUN="${{ steps.params.outputs.dry_run }}"
                  RETENTION_DAYS="${{ steps.params.outputs.retention_days }}"
                  CUTOFF_DATE="${{ steps.cutoff.outputs.cutoff_date }}"
                  
                  echo "### NPM Package Cull Summary" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "**Package:** \`@${{ env.PACKAGE_OWNER }}/${{ env.PACKAGE_NAME }}\`" >> $GITHUB_STEP_SUMMARY
                  echo "**Retention Period:** ${RETENTION_DAYS} days" >> $GITHUB_STEP_SUMMARY
                  echo "**Cutoff Date:** \`${CUTOFF_DATE}\`" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  
                  if [ "$DRY_RUN" = "true" ]; then
                    echo "**Mode:** Dry Run (no packages were deleted)" >> $GITHUB_STEP_SUMMARY
                  else
                    echo "**Mode:** Live Run" >> $GITHUB_STEP_SUMMARY
                  fi
                  echo "" >> $GITHUB_STEP_SUMMARY
                  
                  echo "#### Retention Policy" >> $GITHUB_STEP_SUMMARY
                  echo "- Release versions (format \`x.y.z\`) are **never** deleted" >> $GITHUB_STEP_SUMMARY
                  echo "- Non-release versions older than ${RETENTION_DAYS} days are deleted" >> $GITHUB_STEP_SUMMARY
