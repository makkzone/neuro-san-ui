#    Copyright 2025 Cognizant Technology Solutions Corp, www.cognizant.com.
#
#    Licensed under the Apache License, Version 2.0 (the "License");
#    you may not use this file except in compliance with the License.
#    You may obtain a copy of the License at
#
#    http://www.apache.org/licenses/LICENSE-2.0
#
#    Unless required by applicable law or agreed to in writing, software
#    distributed under the License is distributed on an "AS IS" BASIS,
#    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#    See the License for the specific language governing permissions and
#    limitations under the License.

# This workflow publishes the package to GitHub Packages when a release is published.
# It can also be triggered manually for testing purposes.

name: Publish Package

on:
    release:
        types: [published]
    workflow_dispatch:
        inputs:
            dist_tag:
                description: "npm dist-tag for manual publish"
                type: choice
                required: false
                options:
                    - prerelease
                    - next
                    - beta
                    - rc
                    - canary
                    - dev
                default: prerelease

permissions:
    contents: read
    packages: write

jobs:
    publish:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Set up yarn version
              run: |
                  corepack enable
                  corepack install
                  yarn --version

            - name: Use Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 22.17.1
                  registry-url: https://npm.pkg.github.com/
                  scope: "@cognizant-ai-lab"
                  cache: yarn

            - name: Install dependencies
              run: |
                  rm -rf node_modules
                  yarn cache clean --all
                  yarn install --immutable

            - name: Generate OpenAPI types
              run: yarn generate

            - name: Compute version and dist-tag
              id: compute
              run: |
                  if [ "${{ github.event_name }}" = "release" ]; then
                    # Release: use release tag for version, "latest" for dist-tag
                    TAG="${{ github.event.release.tag_name }}"
                    VERSION="${TAG#v}"
                    DIST_TAG="latest"
                    echo "Publishing release version: $VERSION with dist-tag: $DIST_TAG"
                  else
                    # Manual: use git SHA for version, user-selected dist-tag
                    SHORT_SHA="$(git rev-parse --short "$GITHUB_SHA")"
                    # Read base version from ui-common/package.json
                    BASE_VERSION=$(node -e "console.log(require('./packages/ui-common/package.json').version)")
                    # Create unique pre-release version: <base>-pr.<sha>.<run>
                    VERSION="${BASE_VERSION%%-*}-pr.${SHORT_SHA}.${{ github.run_number }}"
                    DIST_TAG="${{ inputs.dist_tag || 'prerelease' }}"
                    echo "Publishing manual version: $VERSION with dist-tag: $DIST_TAG"
                  fi
                  echo "version=$VERSION" >> "$GITHUB_OUTPUT"
                  echo "dist_tag=$DIST_TAG" >> "$GITHUB_OUTPUT"

            - name: Set ui-common version
              working-directory: packages/ui-common
              run: yarn version set ${{ steps.compute.outputs.version }}

            - name: Build ui-common library
              run: yarn build:lib

            - name: Publish to GitHub Packages
              # Note: --tag sets the npm "dist-tag" (not the git tag or version number).
              # For releases: uses "latest" so `npm install @cognizant-ai-lab/ui-common` gets this version.
              # For manual runs: uses selected dist-tag (e.g., "prerelease") to avoid affecting "latest".
              # The actual package version (e.g., 1.3.1 or 1.2.4-pr.abc123.456) is set in the previous step.
              run: yarn workspace @cognizant-ai-lab/ui-common npm publish --tag ${{ steps.compute.outputs.dist_tag }}
              env:
                  YARN_NPM_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                  NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
