#    Copyright 2025 Cognizant Technology Solutions Corp, www.cognizant.com.
#
#    Licensed under the Apache License, Version 2.0 (the "License");
#    you may not use this file except in compliance with the License.
#    You may obtain a copy of the License at
#
#    http://www.apache.org/licenses/LICENSE-2.0
#
#    Unless required by applicable law or agreed to in writing, software
#    distributed under the License is distributed on an "AS IS" BASIS,
#    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#    See the License for the specific language governing permissions and
#    limitations under the License.

# This workflow publishes the package to GitHub Packages when a release is published.
# It can also be triggered manually for testing purposes.

name: Publish Package

on:
    release:
        types: [published]
    workflow_dispatch:
        inputs:
            tag:
                description: "Tag to publish (e.g., 'test-1', 'v1.3.2-rc1')"
                required: true
                type: string

permissions:
    contents: read
    packages: write

jobs:
    publish:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Set up yarn version
              run: |
                  corepack enable
                  corepack install
                  yarn --version

            - name: Use Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 22.17.1
                  registry-url: https://npm.pkg.github.com/
                  scope: "@cognizant-ai-lab"
                  cache: yarn

            - name: Install dependencies
              run: |
                  rm -rf node_modules
                  yarn cache clean --all
                  yarn install --immutable

            - name: Generate OpenAPI types
              run: yarn generate

            - name: Normalize version (remove 'v' prefix if present)
              id: version
              run: |
                  # Get tag from either release event or manual input
                  if [ "${{ github.event_name }}" = "release" ]; then
                    TAG="${{ github.event.release.tag_name }}"
                  else
                    TAG="${{ inputs.tag }}"
                  fi
                  # Remove 'v' prefix if present
                  VERSION="${TAG#v}"
                  echo "normalized_version=$VERSION" >> "$GITHUB_OUTPUT"
                  echo "Publishing version: $VERSION (from tag: $TAG)"

            - name: Set ui-common version to release tag
              run: yarn workspace @cognizant-ai-lab/ui-common version ${{ steps.version.outputs.normalized_version }}

            - name: Build ui-common library
              run: yarn build:lib

            - name: Publish to GitHub Packages
              run: yarn workspace @cognizant-ai-lab/ui-common npm publish --tag latest
              env:
                  YARN_NPM_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                  NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
